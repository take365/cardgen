目的 / ゴール

画面上のテキスト（タイトル/説明など）に使うベースフォントを初回のみ選択させる。

2回目以降はUIをロックし、裏側ではデフォルト優先順位 Noto Sans JP, system-ui, sans-serif を用い、ユーザーが追加したWebフォントがある場合はそれを最優先に適用。

追加フォントはGoogle Fontsを使ってオンデマンド読み込み。以降はlocalStorage（UI状態）＋**ブラウザHTTPキャッシュ or SW Cache（実体）**で再利用。

スコープ

フォント選択UI（初回のみ有効なプルダウン +「＋追加」モーダル）

Google Fonts CSS API v2 での読み込み

（任意）Google Fonts Developer API を使った検索/トレンド取得

状態保存（localStorage）と復元

Font Loading の完了検知とUI反映

非対象（別タスク）

文面の自動折返し/縮小ロジック

テキストエンジン自体（KonvaやCanvas等）

権利表記やToS表示

主要ユーザーフロー

初回起動

画面上にフォント選択プルダウン（以下「メインプルダウン」）。
デフォルト：（デフォルト） を選択状態。

リスト内容：

推奨Webフォント（例：Noto Sans JP, Noto Serif JP, Cinzel, Roboto Mono）

OSローカルフォント（system-ui, Arial など）

**［＋ 追加］**ボタンを押すとモーダルへ。

＋追加モーダル

方式A（MVP）：抜粋カタログ（自前JSON） の検索/選択

方式B（拡張）：Developer API で ?sort=trending やカテゴリ検索

フォント家族＋必要ウェイト（例：400/700）を選ぶ → 読み込み実行

読み込み完了検知（Font Loading API）後、メインプルダウンに項目追加 & 選択状態に反映

選択値（familyとウェイトセット）をlocalStorageに保存

2回目以降の起動

メインプルダウンは無効化（読み取り専用）

localStorage から選択済みフォントを復元 → <link rel="stylesheet" …> 動的挿入 → document.fonts.ready 待ち → CSS変数へ適用

該当フォントが存在しない/読み込めない場合はフォールバック：Noto Sans JP, system-ui, sans-serif

UI仕様
メインプルダウン

ラベル：フォント

初回のみ enabled=true、2回目以降は disabled=true（※「初期値を固定する」仕様のため）

選択肢（例）

（デフォルト） → 内部値: default

"Noto Sans JP" (Web)

"Noto Serif JP" (Web)

"Cinzel" (Web)

"system-ui" (Local)

"Arial" (Local)

ユーザー追加（localStorage復元）

＋追加モーダル

入力：検索テキスト、カテゴリ（Serif/Sans/Mono/Display/Handwriting）

結果一覧：ファミリー名、プレビュー、使用例（サンプル文字列）

ウェイト選択（例：400/700）

「追加」→ 読み込み → 完了でメインプルダウンに反映

データ仕様
localStorage キー

cardgen.fontUser : CSS font-family スタック文字列
例："Cinzel", "Noto Sans JP", system-ui, sans-serif

cardgen.fontUserMeta : JSON（family, weights[], url）※ユーザー追加分の配列

[
  {
    "label": "Cinzel (Web)",
    "family": "Cinzel",
    "weights": [700],
    "url": "https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap"
  }
]


cardgen.firstRunComplete : "true" であればプルダウンを disabled に

組み込みフォント定義（固定 JSON）
[
  { "label": "Noto Sans JP (Web)", "family": "Noto Sans JP", "weights": [400,700],
    "url": "https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" },
  { "label": "Noto Serif JP (Web)", "family": "Noto Serif JP", "weights": [400,700],
    "url": "https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" },
  { "label": "Cinzel (Web)", "family": "Cinzel", "weights": [700],
    "url": "https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" },
  { "label": "system-ui (Local)", "family": "system-ui", "local": true },
  { "label": "Arial (Local)", "family": "Arial", "local": true }
]

フォント読み込み仕様
CSS API v2 のURL生成

形式：https://fonts.googleapis.com/css2?family=<Family>:wght@<weights>;&display=swap

例：Noto+Sans+JP:wght@400;700&display=swap

<link> 挿入ルール

id = "gf-" + base64(url) のようにして重複挿入を防止

事前に preconnect を <head> に追加（初回の体感速度向上）

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

ロード完了検知

await document.fonts.load('700 20px "Noto Sans JP"')

await document.fonts.ready

失敗時はフォールバック（下記）

フォント適用（CSS 変数式）

既定スタック（裏側優先順位）

:root {
  --font-default: "Noto Sans JP", system-ui, sans-serif;
  --font-user: var(--font-default);
}
.card-title { font-family: var(--font-user); font-weight: 700; }
.card-text  { font-family: var(--font-user); font-weight: 400; }


ユーザーが追加/選択した場合は、先頭にそのfamilyを差し込んだスタックを --font-user に上書き
例："Cinzel", "Noto Sans JP", system-ui, sans-serif

フォールバック & エラー処理

読み込み失敗：

--font-user = --font-default に戻す

トーストで「読み込み失敗」を通知（ネット/タイポ/アクセス制限など）

未収録文字：

自動で system-ui, sans-serif にフォールバック
me Dagger
日本語は Noto Sans JP/Serif JP を推奨（CJK収録）

パフォーマンス

必要ウェイトのみ取得（基本 400/700）

display=swap をURLに付与

複数ファミリーは1本のURLにまとめる（重複ダウンロード防止）

初回のみメインプルダウン表示、2回目以降は UI ロックで迷わせない
狼むら
（任意）Service Worker キャッシュ

オフライン時でも表示したい場合、Cache Storage に

https://fonts.googleapis.com/css2?...

https://fonts.gstatic.com/s/.../*.woff2
を保存。

起動時にlocalStorageのエントリを見て、必要なURLをSWにプリキャッシュ依頼。

アクセシビリティ

メインプルダウンに aria-label="フォント選択（初回のみ）"

無効化時は aria-disabled="true" かつ視覚的に「設定済み」メッセージを表示

モーダルは role="dialog"、初期フォーカスを検索欄に

セキュリティ

Developer API を使う場合は API Key をバックエンド経由でプロキシ or ドメイン制限

XSS対策：モーダルの入力は生文字列をそのままDOMに入れない（URLは encodeURIComponent）

テレメトリ（任意）

選択された family 名・weights（匿名）

読み込み成功/失敗

追加モーダルの利用率

受け入れ基準（Acceptance Criteria）

初回のみメインプルダウンからフォントを選べる。2回目以降は無効化され、同じ設定が反映される。

＋追加でWebフォントを読み込み、読み込み後すぐプルダウンに出現して選べる。

追加済みフォントは再起動後も復元される。

フォント読み込み失敗時は既定スタックに自動フォールバックする。

表示はNoto Sans JP, system-ui, sans-serifスタックを下支えに、ユーザー指定フォントが載っている場合は最優先で適用される。

Codex向け TODO（実装タスク粒度）

 fonts.json（組み込み候補）を配置

 <head> に preconnect 追加

 メインプルダウン／＋追加モーダルのUIを実装

 CSS API v2のURL生成関数 buildGfUrl(family, weights)

 <link id="gf-..."> の重複チェック＆挿入

 Font Loading APIでロード完了待ち

 localStorage: 保存/復元 (cardgen.fontUser, cardgen.fontUserMeta, cardgen.firstRunComplete)

 CSS変数 --font-default / --font-user の適用ロジック

 エラーハンドリング＆トースト

 （任意）Developer API 検索用のfetch＋簡易UI

 （任意）Service Workerのプリキャッシュ