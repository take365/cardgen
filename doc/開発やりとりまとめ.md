# Codex CLI 開発やりとりまとめ（カードジェネレータ）

このドキュメントは、Codex CLI と行った実装・調整の経緯を、後から追えるように要点だけ時系列寄りでまとめたものです。

## 目的・スコープ
- 目的: デジタルボドゲ向けのカード画像を、登録不要・低学習コストで生成（透過PNG出力）。
- スコープ: 素材選択 → 自動配置 → 微調整 → PNG保存。静的配信（nginx）で完結。

## 初期実装（MVP）
- 追加ファイル: `Dockerfile`, `nginx.conf`, `public/index.html`, `public/styles.css`。
- Konva.js で Stage/Layers を構築（750×1050）。背景・枠・テキスト・アイコンの基本レイヤーを用意。
- サンプルプリセット（色・ベクトル）と PNG 保存（pixelRatio=2）。

## Windows 起動対応
- `start.bat` を作成 → 日本語出力の文字化けや IF ブロックの括弧解釈問題に遭遇。
- 対応: バッチは英数最小化し `start.ps1` を呼び出す方式へ。PS 側は UTF-8 表示＆Base64ラップで日本語メッセージ安全化。
- 使い方: `start.bat` or `powershell -File start.ps1 -Port 8080`。

## アセット取り込みとマニフェスト
- `public/assets/` をスキャンし `public/assets/manifest.json` を生成。
  - PowerShell: `gen_manifest.ps1`
  - Bash: `scripts_gen_manifest.sh`
- ディレクトリ対応: 背景（裏面/backgrounds）、枠（枠/frames）、アイコン（剣/icons/icon）、アイテム（items）。
- `start.ps1` 起動時に自動再生成。

## UI/表示の改善
- 表示倍率セレクト追加（フィット/100/75/66/50）。デフォルト50%。右ペインにツールバーを配置。
- ガイド線トグル（内側 600×900 と 3分割ライン表示）。
- 右ペインの縦切れ対策（スクロール/縮小）。

## 寸法ガイドへの対応
- `doc/カードレイアウト寸法ガイド.md` に基づきゾーンを `main/title/desc` に整理。
- 枠ファイル名ルール `frame-<Main>-<Title>-<Description>.png` からゾーン高を自動反映。
- タイトル/本文は autoLayout で Y+110px、背景は Y+調整（上部あけ）。アイテム初期位置も Y+30px など微調整。

## ステータス仕様の廃止
- 中段ステータスの数値/アイコンは削除。UIと自動配置ロジックを整理。

## フォント選択
- タイトル・本文で別フォントを選択可能に（プルダウン）。
- Google Fonts の CSS URL をモーダルから追加（`css2`形式のみ）→ localStorage に保存・復元。
- タイトル/本文の詳細設定（色/サイズ/太さ/フォント入力）は `details` で折り畳み（必要時のみ開く）。

## アイテム選択のモーダル化
- 左ペインからアイテムのサムネを撤去し、「アイテムを選択」ボタンでモーダルを開く方式に変更。
- モーダルのグリッドは固定枠（128×228、中央寄せ、object-fit: contain）。
- サムネ下にキャプション＆（ブラウザ内素材は）削除ボタンを表示。

## 「取り込み（ブラウザ内保存）」対応
- 用語方針: 「アップロード」ではなく「画像を取り込む（このブラウザに保存）」に統一。
- 永続化は IndexedDB を利用（OS権限不要）。
- 対応カテゴリ: アイテム/背景/枠/アイコン。モーダルのタイトル横に取り込みボタンを配置。
- 取り込んだ素材はキャプション「（ブラウザ内）」で区別。削除ボタンで IndexedDB から削除可能。
- マニフェストの素材（assets 配下）は削除対象外（読み取り専用）。

## 背景/枠/アイコンもモーダル選択に統一
- 各ボタン「背景/枠/アイコンを選択」→ 共通モーダル `assetModal` を開いて該当カテゴリのみ一覧。
- クリックで即反映（背景=cover、枠=fit、アイコン=単一切替）。

## メニュー/文言
- 上部ヘッダーはタイトルのみ。保存・表示倍率は右ペイン上部ツールバーへ移動。
- PNG保存は警告なしに即ダウンロード。
- フッター文言は指定の免責に更新。

## 既知の補足
- Konva のレイヤ数警告（6層）。現状は機能的に問題なし。必要なら Group 化等で最適化余地あり。
- ブラウザ内保存のため、シークレット/別ブラウザでは共有されません。サイトデータ消去で削除。

## 実行メモ
```bash
# Docker
docker build -t cardgen-mvp .
docker run --rm -p 8080:8080 cardgen-mvp
# → http://localhost:8080

# Windows（推奨）
./start.bat  # 内部で start.ps1 を呼び出し、manifestを自動生成
```

## 今後の拡張アイデア（メモ）
- モーダルに検索・ページング・タグフィルタ。
- 取り込み素材の一括追加/複数選択、プレビュー拡大。
- アイコンの回転/整列、ガイドスナップ、Undo/Redo。
- エクスポート解像度の選択、透過/背景色切替。

